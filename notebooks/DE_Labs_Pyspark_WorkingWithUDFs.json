{"paragraphs":[{"text":"%md\n# About This Lab\n**Objective:** Be able to use User Defined Functions (UDFs) to transform DataFrames\n**File locations:**\n**Successful outcome:**\n**Before you begin:**\n**Related lessons:** Working with DataFrames\n\nCopyright © 2010–2021 Cloudera. All rights reserved.\nNot to be reproduced or shared without prior written consent from Cloudera.\n\n---","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:46:39+0000","config":{"tableHide":true,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","editorHide":false,"fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764919_-541720499","id":"20171105-200834_1116095891","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:40:55+0000","dateFinished":"2022-01-25T13:40:55+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:47634"},{"text":"%md\n## Overview\n\nIn this module we demonstrate how to create and apply user-defined functions.\n\n\n## User-Defined Functions\n\n* It is relatively easy to create and apply a user-defined function (UDF)\n    * Define a Python function that operates on a row of data\n    * Register the Python function as a UDF and specify the return type\n    * Apply the UDF as if it were a built-in function\n\n* Python and any required packages must be installed on the worker nodes\n    * It is possible to distribute required packages via Spark\n\n* Built-in functions are more efficient than user-defined functions\n    * Use built-in functions when available\n    * Create user-defined functions only when necessary\n\n* User-defined function are inefficient because of the following:\n    * A Python process must be started alongside each executor\n    * Data must be converted between Java and Python types\n    * Data must be transferred between the Java and Python processes\n\n* To improve the performance of a UDF:\n    * Use the [Apache Arrow](https://arrow.apache.org/) platform \n    * Use a vectorized UDF (see the `pandas_udf` function)\n    * Rewrite the UDF in Scala or Java","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:40:55+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","fontSize":9,"editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764919_-1235084913","id":"20210610-041300_636880277","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:40:56+0000","dateFinished":"2022-01-25T13:40:56+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47635"},{"text":"%md\n# Setup\n---","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:40:56+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","fontSize":9,"editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764920_1275973353","id":"20181114-164229_902436001","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:41:03+0000","dateFinished":"2022-01-25T13:41:03+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47636"},{"title":"Required for Kerberos operations","text":"%sh\n\necho $PASS | kinit $USER","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:47:42+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"sh","editOnDblClick":false,"completionKey":"TAB","completionSupport":false},"editorMode":"ace/mode/sh","title":true,"tableHide":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117903728_776384275","id":"20220125-133823_334440090","dateCreated":"2022-01-25T13:38:23+0000","dateStarted":"2022-01-25T13:41:04+0000","dateFinished":"2022-01-25T13:41:04+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47637"},{"title":"Setup the data context","text":"%sh\n\nrm -rf data\nmkdir -p data\naws s3 cp --recursive s3://shared-edu/sci/duocar/raw data/raw\nhdfs dfs -rm -r duocar\nhdfs dfs -mkdir -p duocar\nhdfs dfs -put -f data duocar","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:48:13+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"sh","editOnDblClick":false,"completionKey":"TAB","completionSupport":false},"editorMode":"ace/mode/sh","title":true,"tableHide":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117899406_1627390537","id":"20220125-133819_900096021","dateCreated":"2022-01-25T13:38:19+0000","dateStarted":"2022-01-25T13:41:05+0000","dateFinished":"2022-01-25T13:41:16+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47638"},{"title":"Read the raw ride data from HDF and clean it","text":"%pyspark\n\nrides = spark.read.csv(\"duocar/data/raw/rides/\", header=True, inferSchema=True)\n\n# Cast `date_time` to a timestamp:\nfrom pyspark.sql.functions import col\nrides_clean = rides.withColumn(\"date_time\", col(\"date_time\").cast(\"timestamp\"))","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:41:16+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764920_-1499329410","id":"20210610-041458_574907270","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:41:25+0000","dateFinished":"2022-01-25T13:41:28+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47639"},{"text":"%md\n# Lesson\n---","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:41:28+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","fontSize":9,"editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764920_1594482418","id":"20210609-150445_381117564","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:41:35+0000","dateFinished":"2022-01-25T13:41:35+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47640"},{"text":"%md\n## Example 1: Hour of Day","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:41:35+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","fontSize":9,"editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764920_-149512150","id":"20210610-041602_390464956","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:41:36+0000","dateFinished":"2022-01-25T13:41:36+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47641"},{"title":"Define the Python function","text":"%pyspark\n\nimport datetime\ndef hour_of_day(timestamp):\n  return timestamp.hour","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:41:36+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764920_-893203637","id":"20210610-041616_689400131","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:41:40+0000","dateFinished":"2022-01-25T13:41:41+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47642"},{"title":"Note","text":"%md\nThe Spark `TimestampType` corresponds to Python `datetime.datetime` objects.","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:41:41+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","fontSize":9,"editorHide":true,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764920_43345454","id":"20210610-041801_1207629809","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:41:42+0000","dateFinished":"2022-01-25T13:41:42+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47643"},{"title":"Test the Python function","text":"%pyspark\n\ndt = datetime.datetime(2017, 7, 21, 5, 51, 10)\nhour_of_day(dt)","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:41:42+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764921_-1666025236","id":"20210610-041853_1273796548","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:41:48+0000","dateFinished":"2022-01-25T13:41:49+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47644"},{"title":"Register the Python function as a UDF","text":"%pyspark\n\nfrom pyspark.sql.functions import udf\nfrom pyspark.sql.types import IntegerType\nhour_of_day_udf = udf(hour_of_day, returnType=IntegerType())","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:41:49+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764921_-1263129269","id":"20210610-041937_709330143","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:41:55+0000","dateFinished":"2022-01-25T13:41:56+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47645"},{"title":"Note","text":"%md\nWe must explicitly specify the return type otherwise it defaults to `StringType`.","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:41:56+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","fontSize":9,"editorHide":true,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764921_1417029832","id":"20210610-042031_810204586","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:41:58+0000","dateFinished":"2022-01-25T13:41:58+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47646"},{"title":"Apply the UDF","text":"%pyspark\n\nrides_clean \\\n  .select(\"date_time\", hour_of_day_udf(\"date_time\")) \\\n  .show(5, truncate=False)","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:41:58+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764921_898998725","id":"20210610-042028_341706402","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:42:05+0000","dateFinished":"2022-01-25T13:42:07+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47647"},{"title":"Use the UDF to compute the number of rides by hour of day","text":"%pyspark\n\nrides_clean \\\n  .select(hour_of_day_udf(\"date_time\").alias(\"hour_of_day\")) \\\n  .groupBy(\"hour_of_day\") \\\n  .count() \\\n  .orderBy(\"hour_of_day\") \\\n  .show(25)","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:42:07+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764921_607739817","id":"20210610-042204_1273871975","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:42:08+0000","dateFinished":"2022-01-25T13:42:10+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47648"},{"text":"%md\n## Example 2: Great-Circle Distance\n\nThe [great-circle distance](https://en.wikipedia.org/wiki/Great-circle_distance) is the shortest distance between two points on the surface of a sphere. \nIn this example we create a user-defined function to compute the [haversine approximation](https://en.wikipedia.org/wiki/Haversine_formula) to the great-circle distance between the ride origin and destination.","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:42:10+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","fontSize":9,"editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764921_1302834550","id":"20210610-042619_599441245","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:42:13+0000","dateFinished":"2022-01-25T13:42:13+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47649"},{"title":"Define the haversine function","text":"%pyspark\n\nfrom math import radians, sin, cos, sqrt, asin\ndef haversine(lat1, lon1, lat2, lon2):\n  \"\"\"\n  Return the haversine approximation to the great-circle distance between two\n  points (in meters).\n  \"\"\"\n  R = 6372.8 # Earth radius in kilometers\n \n  dLat = radians(lat2 - lat1)\n  dLon = radians(lon2 - lon1)\n\n  lat1 = radians(lat1)\n  lat2 = radians(lat2)\n \n  a = sin(dLat / 2.0)**2 + cos(lat1) * cos(lat2) * sin(dLon / 2.0)**2\n  c = 2.0 * asin(sqrt(a))\n \n  return R * c * 1000.0","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:42:13+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764922_1431019985","id":"20210610-042616_1193140066","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:42:14+0000","dateFinished":"2022-01-25T13:42:15+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47650"},{"title":"Note","text":"%md\nWe have made some minor changes to the code  at [rosettacode.org](http://rosettacode.org/wiki/Haversine_formula#Python) to make it integer proof.","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:42:15+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","fontSize":9,"editorHide":true,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764922_58135370","id":"20210610-043008_126340998","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:42:16+0000","dateFinished":"2022-01-25T13:42:16+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47651"},{"title":"Test the Python function","text":"%pyspark\n\nhaversine(36.12, -86.67, 33.94, -118.40)  # = 2887259.9506071107","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:42:16+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764922_2000343436","id":"20210610-043006_1412529659","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:42:23+0000","dateFinished":"2022-01-25T13:42:24+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47652"},{"title":"Register the Python function as a UDF","text":"%pyspark\n\nfrom pyspark.sql.types import DoubleType\nhaversine_udf = udf(haversine, returnType=DoubleType())","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:42:25+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764922_-1811735433","id":"20210610-043318_1494705441","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:42:30+0000","dateFinished":"2022-01-25T13:42:31+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47653"},{"title":"Apply the haversine UDF","text":"%pyspark\n\ndistances = rides \\\n  .withColumn(\"haversine_approximation\", haversine_udf(\"origin_lat\", \"origin_lon\", \"dest_lat\", \"dest_lon\")) \\\n  .select(\"distance\", \"haversine_approximation\")\ndistances.show(5)","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:42:31+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764922_1781041175","id":"20210610-043404_145411034","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:42:35+0000","dateFinished":"2022-01-25T13:42:36+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47654"},{"title":"We expect the haversine approximation to be less than the ride distance","text":"%pyspark\n\ndistances \\\n  .select((col(\"haversine_approximation\") > col(\"distance\")).alias(\"haversine > distance\")) \\\n  .groupBy(\"haversine > distance\") \\\n  .count() \\\n  .show()\n\n# The null values correspond to cancelled rides:\nrides.filter(col(\"cancelled\") == 1).count()\n\n# The true values reflect the fact that the haversine formula is only an approximation to the great-circle distance:\ndistances.filter(col(\"haversine_approximation\") > col(\"distance\")).show(5)","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:42:36+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764923_367768749","id":"20210610-043506_1356303268","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:42:36+0000","dateFinished":"2022-01-25T13:42:38+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47655"},{"text":"%md\n# Lab\n---","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:42:39+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","fontSize":9,"editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764923_670341610","id":"20210609-150527_79851234","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:42:45+0000","dateFinished":"2022-01-25T13:42:45+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47656"},{"title":"1- Create a UDF that extracts the day of the week from a timestamp column","text":"%pyspark\n","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:42:45+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764923_1971544812","id":"20210610-044141_285955384","dateCreated":"2022-01-25T13:36:04+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47657"},{"title":"Hint","text":"%md\nUse the [weekday](https://docs.python.org/2/library/datetime.html#datetime.datetime.weekday) method of the Python `datetime` class.","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:42:46+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","fontSize":9,"editorHide":true,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764923_-1427676722","id":"20210610-044216_1671051028","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:42:52+0000","dateFinished":"2022-01-25T13:42:52+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47658"},{"title":"2 - Use the UDF to compute the number of rides by day of week","text":"%pyspark\n","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:42:53+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764923_1231441184","id":"20210610-044215_1321572347","dateCreated":"2022-01-25T13:36:04+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47659"},{"title":"3 - Use the built-in function `dayofweek` to compute the number of rides by day of week","text":"%pyspark\n","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:42:58+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764923_1899839121","id":"20210610-044211_691709824","dateCreated":"2022-01-25T13:36:04+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47660"},{"text":"%md\n# Result\n**You have now:** Learned how to use UDFs to transform DataFrames\n\n---","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:43:02+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","fontSize":9,"editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764924_-1636591997","id":"20181119-142716_792318228","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:43:03+0000","dateFinished":"2022-01-25T13:43:03+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47661"},{"text":"%md\n# Solution\n---","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:43:03+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","fontSize":9,"editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764924_-822289123","id":"20171113-155535_1769142099","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:43:04+0000","dateFinished":"2022-01-25T13:43:04+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47662"},{"title":"1- Create a UDF that extracts the day of the week from a timestamp column","text":"%pyspark\n\n# Define the Python function:\nimport datetime\ndef day_of_week(timestamp):\n  return timestamp.weekday()\n\n# Register the Python function as a UDF: \nfrom pyspark.sql.functions import udf\nfrom pyspark.sql.types import IntegerType\nday_of_week_udf = udf(day_of_week, returnType=IntegerType())\n\n# Apply the UDF:\nrides_clean \\\n  .select(\"date_time\", day_of_week_udf(\"date_time\")) \\\n  .show(5, truncate=False)","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:43:04+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"editorHide":false,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764924_-608000211","id":"20210610-044512_1580013731","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:43:04+0000","dateFinished":"2022-01-25T13:43:05+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47663"},{"title":"2 - Use the UDF to compute the number of rides by day of week","text":"%pyspark\n\nrides_clean \\\n  .withColumn(\"day_of_week\", day_of_week_udf(\"date_time\")) \\\n  .groupBy(\"day_of_week\") \\\n  .count() \\\n  .orderBy(\"day_of_week\") \\\n  .show()","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:43:06+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"editorHide":false,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764924_752257022","id":"20210610-044451_1176689375","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:43:11+0000","dateFinished":"2022-01-25T13:43:12+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47664"},{"title":"3 - Use the built-in function `dayofweek` to compute the number of rides by day of week","text":"%pyspark\n\nfrom pyspark.sql.functions import dayofweek\nrides_clean \\\n  .withColumn(\"dayofweek\", dayofweek(\"date_time\")) \\\n  .groupBy(\"dayofweek\") \\\n  .count() \\\n  .orderBy(\"dayofweek\") \\\n  .show()","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:43:12+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"editorHide":false,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764924_674594714","id":"20210610-044445_590752683","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:43:13+0000","dateFinished":"2022-01-25T13:43:14+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47665"},{"title":"Note","text":"%md\nDay 1 represents Sunday.","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:43:14+0000","config":{"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764925_-1788425956","id":"20210610-045022_306202457","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:43:18+0000","dateFinished":"2022-01-25T13:43:18+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47666"},{"text":"%md\n## References\n\n* [Python API - datetime module](https://docs.python.org/2/library/datetime.html)\n\n* [Spark Python API - pyspark.sql.functions.udf](http://spark.apache.org/docs/latest/api/python/reference/api/pyspark.sql.functions.udf.html)\n\n* [Spark Python API - pyspark.sql.functions.pandas_udf](http://spark.apache.org/docs/latest/api/python/reference/api/pyspark.sql.functions.pandas_udf.html#pyspark.sql.functions.pandas_udf)\n\n* [Cloudera Engineering Blog - Working with UDFs in Apache Spark](https://blog.cloudera.com/blog/2017/02/working-with-udfs-in-apache-spark/)\n\n* [Cloudera Engineering Blog - Use your favorite Python library on PySpark cluster with Cloudera Data Science Workbench](https://blog.cloudera.com/blog/2017/04/use-your-favorite-python-library-on-pyspark-cluster-with-cloudera-data-science-workbench/)\n","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:43:18+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","fontSize":9,"editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764925_-1226364566","id":"20210610-043628_1324497606","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:43:24+0000","dateFinished":"2022-01-25T13:43:24+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47667"},{"title":"Additional resources","text":"%md\nWe hope you've enjoyed this lab. Below are additional resources that you should find useful:\n\n1. [Cloudera Tutorials](http://cloudera.com/tutorials.html) are your natural next step where you can explore Spark in more depth.\n2. [Cloudera Community](https://community.cloudera.com) is a great resource for questions and answers on Spark, Data Analytics/Science, and many more Big Data topics.\n3. [Apache Spark Documentation](https://spark.apache.org/documentation.html) - official Spark documentation.\n4. [Apache Zeppelin Project Home Page](https://zeppelin.apache.org) - official Zeppelin web site.","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:43:24+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":10,"editorMode":"ace/mode/markdown","fontSize":9,"editorHide":true,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764925_-1215173607","id":"20181116-135131_93712280","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:43:25+0000","dateFinished":"2022-01-25T13:43:25+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47668"},{"text":"%angular\n</br>\n</br>\n</br>\n</br>\n<center>\n<a href=\"https://www.cloudera.com/about/training/courses.html\">\n  <img src=\"https://www.cloudera.com/content/dam/www/marketing/media-kit/logo-assets/cloudera_logo_darkorange.png\" alt=\"Cloudera University\" style=\"width:280px;height:40px;border:0;\" align=\"middle\">\n</a>\n</center>\n</br>\n</br>","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:43:25+0000","config":{"tableHide":false,"editorSetting":{"language":"scala","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":2,"editorMode":"ace/mode/undefined","fontSize":9,"editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764925_429000244","id":"20200110-154537_1406191376","dateCreated":"2022-01-25T13:36:04+0000","dateStarted":"2022-01-25T13:43:26+0000","dateFinished":"2022-01-25T13:43:26+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47669"},{"text":"%angular\n","user":"freynalddeveuwest1","dateUpdated":"2022-01-25T13:43:26+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/undefined","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1643117764926_2102617926","id":"20200110-162013_302547143","dateCreated":"2022-01-25T13:36:04+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:47670"}],"name":"DE/Labs/Pyspark/WorkingWithUDFs","id":"2GVDEVKPX","noteParams":{},"noteForms":{},"angularObjects":{"md:shared_process":[],"angular:shared_process":[],"sh:shared_process":[],"livy:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}